# Equipment Status Application

This application allows you to manage your industry equipment and their status. The application backend API is built using Serverless Framework and the frontend client is built using React.

# Functionality of the application

**The application allows:**

* A user to log in to the application to see the list of equipment owned.
* Add a new equipment by providing an equipment `name` and an equipment `status`.
* Change the status of an equipment to either `Up`, `Down`, or `Limited`.
* Attach an image to the equipment. Or re-attach a different image.
* View the file attachment history of an equipment by clicking on **File upload history** below the equipment image.
* View the total number of equipment that are in the `Up`, `Down`, and `Limited` status by clicking on the **Status Count** button.
* Delete an equipment that is no longer in service.
* Log out of the application.

# Backend

The source code for the API is in the **`backend`** folder. The Serverless application was created using the following command:

> **`sls create --template aws-nodejs-typescript --path backend --name serverless-equipment-status-app`**

Additional files were added to implement the API for Equipment Status application.

* The **serverless.yml** file is used to provision all the resources in AWS used by the application.

* The `models` folder contains JSON files used by API Gateway to validate the request for creating a new equipment and updating an equipment.

* The `src\auth` folder contains utilities for retrieving and validating JWT token from Auth0 service.

* The data layer logic lives in file `src\helpers\equipmentAcess.ts`

* The business layer logic lives in file `src\helpers\equipment.ts`

* The file storage layer logic lives in file `src\helpers\attachmentUtils.ts`

* Cloudwatch access used for generating metrics lives in file `src\helpers\metricUtils.ts`

* Lambda functions live in `src\lambda` folder

* Database models live in `src\models` folder

* Request models live in `src\requests` folder

## File serverless.yml explained

**Amazon AWS services used include, but not limited to:**

* Lambda functions
* DynamoDb Tables
* S3 Bucket
* SNS (publish and subscribe to topics)
* DynamoDb stream
* XRay Tracing
* CloudWatch Logs
* CloudWatch Metrics
* API Gateway request validations
* IAM roles

**Tables**

There are three DynamoDb tables used in the backend deployment:

Table **EquipmentTable** is used to store information about the equipment such as name, status, attachment URL. **DynamoDB Stream** is turned on for this table. The table fields include:
* `userId` (string) - The unique user Id of the user who created and thus owns the equipment.
* `equipmentId` (string) - The unique Id of the equipment. Generated when the equipment is first created.
* `attachmentUrl` (string) - The URL that points to the equipment's attached image that lives in S3 bucket.
* `createdAt` (string) - The timestamp of when the equipment was first created.
* `name` (string) - The name of the equipment.
* `status` (string) - The current status of the equipment. Can be `Up`, `Down`, or `Limited`.
* `statusChangedAt` (string) - The timestamp of when the equipment's status was last changed.


Table **EquipmentStatisticsTable** is used to store the total number of equipment that are in the Up, Down, and Limited status. The table fields include:
* `userId` (string) - The unique user Id of the user who created and thus owns the equipment.
* `statusName` (string) - The status name of either `Up`, `Down`, or `Limited`.
* `statusCount` (number) - An integer representing the total number of equipment that is in the status `statusName`.
* `updatedAt` (string) - The timestamp of when the status count was last updated.

Table **AttachmentHistTable** is used to store a running history of when an image is uploaded to or deleted from the S3 bucket. The table fields include:
* `fileId` (string) - The file key used when uploading the file to S3 bucket. Note: the application uses the `equipmentId` as the file key in this case.
* `historyId` (string) - The unique Id generated by the application everytime it records an S3 file upload or delete event to this table.
* `eventName` (string) - The event that occurred in S3 bucket. Can either be `File Uploaded` or `File Deleted`.
* `eventTime` (string) - The timestamp of when the file was uploaded or deleted from S3 bucket.
* `fileEtag` (string) - The version of the file. Reflects changes to the file contents.
* `fileSequencer` (string) - A value used to determine the ordering of events impacting a single file object. Not used in application but included for completeness.
* `fileSize` (number) - The size of the uploaded file in bytes.

**S3 Bucket**

There is one S3 Bucket used in the backend deployment:

* The S3 bucket **AttachmentsBucket** is used to store the equipment's attached image. Each equipment is allowed to have only one image in S3 bucket at any given time. The image name is stored in S3 as the `equipmentId`.
* The S3 bucket publishes to 2 SNS topics. It publishes to SNS topic `ImagesTopic` when there is a file uploaded to the S3 bucket and publishes to SNS topic `ImagesTopicForFileDelete` when a file is deleted from S3 bucket.

**Lambda Functions**

There are 11 Lambda functions used in the backend deployment:

* `Auth` - Check the validity of the JWT token from a request and allows the application to authenticate users.
* `GetEquipmentList` - Handle request to get the list of equipment owned by a user.
* `CreateEquipment` - Handle request to create a new equipment.
* `UpdateEquipment` - Handle request to change status of an equipment. Note: can also used to change the name of the equipment but a decision is made to not implement in React client.
* `DeleteEquipment` - Handle request to delete an equipment. Attached image for the equipment will also be deleted from S3.
* `GenerateUploadUrl` - Handle request to get a pre-signed URL for uploading an image to S3 bucket.
* `RecordUploadHistory` - Save an entry to the `AttachmentHistTable` table when notified by an SNS topic that a file has been uploaded to S3 bucket. This lambda function subscribes to the SNS topic `ImagesTopic`.
* `RecordDeleteHistory` - Save an entry to the `AttachmentHistTable` table when notified by an SNS topic that a file has been deleted from S3 bucket. This lambda function subscribes to the SNS topic `ImagesTopicForFileDelete`.
* `UpdateEqStats` - Add or update an entry in the `EquipmentStatisticsTable` table when detects there is an equipment created, deleted, or updated in the `EquipmentTable` DynamoDB table stream. Consumes records from DynamoDB stream.
* `GetEqStats` - Handle request to get the total number of equipment in the Up, Down, and Limited status.
* `GetFileHistory` - Get the history of image attachment for an equipment.

## HTTP Endpoints

`GET ${apiEndpoint}/equipment`
* Get equipment list

 `POST ${apiEndpoint}/equipment`
* Create equipment. Provide `name` and `status` as JSON input in the HTML body.

`PATCH ${apiEndpoint}/equipment/${equipmentId}`
* Update equipment. Provide `name` and `status` as JSON input in the HTML body.

`DELETE ${apiEndpoint}/equipment/{equipmentId}`
* Remove equipment

`POST ${apiEndpoint}/equipment/{equipmentId}/attachment`
* Request presigned URL

`GET ${apiEndpoint}/equipment/statuscount`
* Get total Up, Down, Limited equipment status count

`GET ${apiEndpoint}/equipment/filehistory/{equipmentId}`
* Get file upload history for an equipment

## Authentication

The application implements authentication using Auth0 service. An application is created in Auth0 and the "domain" and "client id" is copied to the `config.ts` file in the `client` folder. Asymmetrically encrypted JWT tokens are used.

# Frontend

The source code for the React client application is in the **`client`** folder.
The React application was created using the following command:

> **`npx create-react-app client --template typescript`**

Additional files were added to interact with the Equipment Status backend API.

* The configuration file is located `client\src\config.ts` and contains API access information.

* Calls to API endpoints live in file `src\api\equipmentList-api.ts`

* Auth0 Authentication lives in file `src\Auth.js`

* React components defined for this project live in folder `src\components`

* Models/interfaces define for this project live in folder `src\types`

* File **`index.tsx`** is the starting point of the React application.

* Supporting files to help with rendering of the UI include `src\App.tsx` and `src\routing.tsx`

## Navigating the User Interface

When the React UI is first started, click the green **Log in** button or the one in the navigation bar to log into the application.
<kbd>
![UI Homepage](screenshots/ui/1-Login.png?raw=true "UI Homepage")
</kbd>

Refer to folder `screenshots\ui` for examples of navigating the application UI.

# How to run the application

## Backend

To deploy an application run the following commands:

```
cd backend
npm install
sls deploy -v
```

## Frontend

To run a client application first edit the `client/src/config.ts` file to set correct parameters. And then run the following commands:

```
cd client
npm install
npm run start
```

This should start a development server with the React application that will interact with the serverless Equipment Status application.

# Postman collection

An alternative way to test the backend API, you can use the Postman collection that contains sample requests. You can find a Postman collection file in this project called **Equipment Status.postman_collection.json**. Use Postman to import this file if you need to test the backend API endpoint using Postman instead of the provided frontend React client application provided with this project. Refer to folder `screenshots\postman` for example of import.
<kbd>
![Postman Collection](screenshots/postman/4-Collection%20as%20shown%20in%20Postman%20after%20imported.png?raw=true "Postman Collection")
</kbd>

1. Start the Postman application
1. Import the collection `Equipment Status.postman_collection.json`.
1. Edit the environment variables in the collection and enter in the appropriate value for the `apiId` and `authToken`.
1. Provide request input as appropriate to test the requests.
